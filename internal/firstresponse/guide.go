package firstresponse

import (
	"bytes"
	"fmt"
	"os"
	"text/template"
)

// DefaultGuideTemplate is the default first response guide template
const DefaultGuideTemplate = `<!-- alert-menta:first-response -->
## {{.SeverityEmoji}} ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œã‚¬ã‚¤ãƒ‰

**é‡å¤§åº¦**: {{.Severity}} {{.SeverityEmoji}}
{{if .Issue.Title}}**Issue**: {{.Issue.Title}}{{end}}

---

### Step 1: çŠ¶æ³ç¢ºèª (ä»Šã™ã)
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§çŠ¶æ³ã‚’æŠŠæ¡ã—ã¦ãã ã•ã„:
` + "```" + `
/describe
` + "```" + `

### Step 2: å½±éŸ¿ç¯„å›²ã®ç¢ºèª
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿ã®æœ‰ç„¡ã‚’ç¢ºèª
- [ ] å½±éŸ¿ã‚’å—ã‘ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹/ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç‰¹å®š
- [ ] ç™ºç”Ÿé »åº¦ã‚’ç¢ºèªï¼ˆç¶™ç¶šä¸­ or æ–­ç¶šçš„ï¼‰

### Step 3: ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³
{{if .SlackChannel}}- {{.SlackChannel}} ãƒãƒ£ãƒ³ãƒãƒ«ã§å ±å‘Š{{else}}- Slackã® #incidents ãƒãƒ£ãƒ³ãƒãƒ«ã§å ±å‘Š{{end}}
- å¿…è¦ã«å¿œã˜ã¦ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
{{if .OnCallTeam}}
**ã‚ªãƒ³ã‚³ãƒ¼ãƒ«æ‹…å½“**: {{range .OnCallTeam}}{{.}} {{end}}
{{end}}

### Step 4: èª¿æŸ»é–‹å§‹
é¡ä¼¼ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã¨å¯¾å¿œæ‰‹é †ã‚’ç¢ºèª:
` + "```" + `
/runbook
` + "```" + `

æ ¹æœ¬åŸå› ã‚’åˆ†æ:
` + "```" + `
/analysis
` + "```" + `

---

### åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰
| ã‚³ãƒãƒ³ãƒ‰ | èª¬æ˜ |
|----------|------|
{{range .Commands}}| ` + "`" + `/{{.Name}}` + "`" + ` | {{.Description}} |
{{end}}

---

{{if .EscalationTimeout}}â±ï¸ å¯¾å¿œé–‹å§‹ã‹ã‚‰{{.EscalationTimeout}}çµŒéã—ã¦ã‚‚è§£æ±ºã®ç›®å‡¦ãŒç«‹ãŸãªã„å ´åˆã¯ã€ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚{{end}}

<sub>ğŸ¤– Generated by alert-menta first-response</sub>
`

// HighSeverityTemplate is the template for high severity incidents
const HighSeverityTemplate = `<!-- alert-menta:first-response -->
## ğŸ”´ ç·Šæ€¥ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œã‚¬ã‚¤ãƒ‰

**é‡å¤§åº¦**: HIGH (Sev1) ğŸ”´
{{if .Issue.Title}}**Issue**: {{.Issue.Title}}{{end}}

---

### âš¡ å³åº§ã«å®Ÿè¡Œ

1. **ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹**
   {{if .SlackChannel}}- {{.SlackChannel}} ã«å‚åŠ {{else}}- #incident-war-room ã«å‚åŠ {{end}}
   - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚’é–‹å§‹

2. **çŠ¶æ³æŠŠæ¡**
   ` + "```" + `
   /describe
   ` + "```" + `

3. **å½±éŸ¿ç¯„å›²ã®ç¢ºèª**
   - [ ] æœ¬ç•ªç’°å¢ƒã¸ã®å½±éŸ¿ã‚’ç¢ºèª
   - [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°/ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã¸ã®å½±éŸ¿
   - [ ] ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ç¢ºèª

### ğŸ” èª¿æŸ»ãƒ•ã‚§ãƒ¼ã‚º

4. **æ ¹æœ¬åŸå› åˆ†æ**
   ` + "```" + `
   /analysis
   ` + "```" + `

5. **å¯¾å¿œæ‰‹é †ã®ç¢ºèª**
   ` + "```" + `
   /runbook
   ` + "```" + `

### ğŸ“‹ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- [ ] ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå®£è¨€å®Œäº†
- [ ] é–¢ä¿‚è€…ã¸ã®é€šçŸ¥å®Œäº†
- [ ] åŸå› ç‰¹å®š
- [ ] ä¸€æ™‚å¯¾å¿œå®Ÿæ–½
- [ ] æ’ä¹…å¯¾å¿œè¨ˆç”»ç­–å®š

---

{{if .OnCallTeam}}**ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…ˆ**: {{range .OnCallTeam}}{{.}} {{end}}{{end}}

â±ï¸ **15åˆ†ä»¥å†…**ã«è§£æ±ºã®ç›®å‡¦ãŒç«‹ãŸãªã„å ´åˆã¯å³åº§ã«ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„ã€‚

<sub>ğŸ¤– Generated by alert-menta first-response</sub>
`

// Generator generates first response guides
type Generator struct {
	config   *Config
	commands []CommandInfo
}

// NewGenerator creates a new guide generator
func NewGenerator(config *Config, commands []CommandInfo) *Generator {
	return &Generator{
		config:   config,
		commands: commands,
	}
}

// Generate generates a first response guide for the given issue
func (g *Generator) Generate(issue IssueSummary, body string) (string, error) {
	// Determine severity
	severity := DetermineSeverity(issue.Labels, body)

	// Prepare template data
	data := TemplateData{
		Issue:         issue,
		Severity:      string(severity),
		SeverityEmoji: SeverityEmoji(severity),
		Commands:      g.commands,
	}

	// Set escalation timeout based on severity
	switch severity {
	case SeverityHigh:
		data.EscalationTimeout = "15åˆ†"
	case SeverityMedium:
		data.EscalationTimeout = "30åˆ†"
	case SeverityLow:
		data.EscalationTimeout = "1æ™‚é–“"
	}

	// Find matching guide configuration
	for _, guide := range g.config.Guides {
		if guide.Severity == string(severity) {
			data.OnCallTeam = guide.AutoNotify
			// If custom template file is specified, try to load it
			if guide.Template != "" {
				content, err := os.ReadFile(guide.Template)
				if err == nil {
					return g.renderTemplate(string(content), data)
				}
				// Fall through to default if file not found
			}
		}
	}

	// Use built-in template based on severity
	var templateStr string
	switch severity {
	case SeverityHigh:
		templateStr = HighSeverityTemplate
	default:
		templateStr = DefaultGuideTemplate
	}

	return g.renderTemplate(templateStr, data)
}

// renderTemplate renders a template with the given data
func (g *Generator) renderTemplate(templateStr string, data TemplateData) (string, error) {
	tmpl, err := template.New("guide").Parse(templateStr)
	if err != nil {
		return "", fmt.Errorf("failed to parse template: %w", err)
	}

	var buf bytes.Buffer
	if err := tmpl.Execute(&buf, data); err != nil {
		return "", fmt.Errorf("failed to execute template: %w", err)
	}

	return buf.String(), nil
}
